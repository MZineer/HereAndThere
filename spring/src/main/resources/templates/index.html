<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Here And There</title>
    <th:block th:replace="fragments/head :: head"></th:block>
    <!-- KAKAO -->
    <script type="text/javascript" th:src="'//dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${apiKey}"></script>
</head>
<body>
<div class="flex-wrap">
    <div>
        <header th:replace="fragments/header :: header"></header>
        <nav th:replace="fragments/nav :: nav"></nav>
    </div>
    <main>
        <div class="container" id="content">
            <div class="row mb-3">
                <div class="mt-3" id="cards">

                </div>
            </div>
        </div>
        <div id="map_window" style="display: none">
            <div id="map">

            </div>
        </div>
    </main>
    <button type="button" class="btn btn-primary fixed-bottom mb-5 mx-auto col-md-1" id="map_btn"
            style="left:0; right:0;">
        지도 열기
    </button>
    <div class="container" id="footer">
        <footer th:replace="fragments/footer :: footer"></footer>
    </div>
</div>
<script>
    $(function () {
        var lat = 35.915455;
        var lng = 128.811749;
        $.ajax({
            type: "GET",
            url: "/admin/tour_list/get",
            success: function (response) {
                // 성공적으로 데이터를 전송한 경우 실행할 코드
                console.log(response); // 서버 응답 확인

                var routes = response.body;

                var routes_cord = [];

                for (var i = 0; i < routes.length; i++) {
                    var cord = {
                        title: routes[i].name,
                        latlng: new kakao.maps.LatLng(parseFloat(routes[i].lat), parseFloat(routes[i].lng))
                    }
                    routes_cord.push(cord);
                }
                displayRoute(routes_cord); // 경로 표시 함수 호출
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
            }
        });

        function displayRoute(routes) {
            var mapContainer = document.getElementById('map'), // 지도를 표시할 div
                mapOption = {
                    center: new kakao.maps.LatLng(lat, lng), // 지도의 중심좌표
                    level: 5 // 지도의 확대 레벨
                };

            var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

// 마커 이미지의 이미지 주소입니다
            var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";

            for (var i = 0; i < routes.length; i++) {

                // 마커 이미지의 이미지 크기 입니다
                var imageSize = new kakao.maps.Size(24, 35);

                // 마커 이미지를 생성합니다
                var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                // 마커를 생성합니다
                var marker = new kakao.maps.Marker({
                    map: map, // 마커를 표시할 지도
                    position: routes[i].latlng, // 마커를 표시할 위치
                    title: routes[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                    image: markerImage // 마커 이미지
                });
            }
        }

        $("#map_btn").click(function () {
            var map_btn_name = $("#map_btn").text();
            if (map_btn_name === "지도 열기") {
                $("#map_btn").text("지도 닫기");
            } else {
                $("#map_btn").text("지도 열기");
            }
            $("#content").toggle();
            $("#footer").toggle();
            $("#map_window").toggle();
        });

        $(window).on("load resize", function () {
            var mapHeight = $(window).height() - $("header").outerHeight() - $(".row.mb-3").outerHeight() - 8;
            var mapWidth = $(window).width();
            $("#map").css("height", mapHeight + "px");
            $("#map").css("width", mapWidth + "px");
        });

        $(".nav-link.nav-bar.category").click(function (e) {
            e.preventDefault();
            var category_name = $(this).data("set");
            console.log(category_name);
            // Hide the previously clicked links
            $(".nav-link.nav-bar").not(this).addClass("collapsed");
            $(".nav-link.nav-bar").not(this).attr("aria-expanded", 'false');
            $(".nav-link.nav-bar").not(this).siblings(".collapse").removeClass("show");

            // Load the content via AJAX
            $.ajax({
                url: "/category/" + category_name,
                method: "GET",
                success: function (response) {
                    console.log(response);
                    // Update the card content
                    var list = response.body;
                    $("#cards").empty();
                    for (var i = 0; i < list.length; i++) {
                        var item = list[i];
                        var cardTitle = item.name;
                        var cardText = item.content;
                        var cardItems = item.category_name.split(" ");

                        var cardHtml = `
                        <div class="card" style="width: 18rem;">
                            <img src="..." class="card-img-top" alt="...">
                            <div class="card-body">
                                <h5 class="card-title">${cardTitle}</h5>
                                <p class="card-text">${cardText}</p>
                            </div>
                            <ul class="list-group list-group-flush">
                            `;

                        if (cardItems && cardItems.length) {
                            for (var j = 0; j < cardItems.length; j++) {
                                var cardItem = cardItems[j];
                                cardHtml += `<li class="list-group-item">${cardItem}</li>`;
                            }
                            cardHtml += `
                                    </ul>
                                    <div class="card-body">
                                        <a href="#" class="card-link">Card link</a>
                                        <a href="#" class="card-link">Another link</a>
                                    </div>
                                </div>
                            `;
                            $("#cards").append(cardHtml);
                        } else {
                            var null_html = `<a>등록된 데이터가 없습니다.</a>`;
                            $("#cards").html(null_html);
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        });
        $("#search_btn").click(function (e) {

        });
    });
</script>
</body>
</html>